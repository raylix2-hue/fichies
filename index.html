<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Envoi de fichiers P2P</title>
<style>
/* Styles globaux */
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
    min-height: 100vh;
    background: linear-gradient(135deg, #74ebd5, #ACB6E5);
}

/* Container principal */
.container {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(15px);
    border-radius: 20px;
    padding: 20px;
    margin-top: 50px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* Inputs et boutons */
input, button {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border-radius: 12px;
    border: none;
    font-size: 16px;
}

input {
    background: rgba(255,255,255,0.3);
    color: #fff;
    outline: none;
}

input::placeholder {
    color: #eee;
}

button {
    background: rgba(255,255,255,0.3);
    color: #fff;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
}

button:hover {
    background: rgba(255,255,255,0.5);
}

/* Liste des utilisateurs */
.user-list {
    width: 100%;
    max-height: 150px;
    overflow-y: auto;
    margin: 10px 0;
}

.user {
    padding: 10px;
    background: rgba(255,255,255,0.2);
    margin-bottom: 5px;
    border-radius: 10px;
    cursor: pointer;
    color: #fff;
    text-align: center;
}

.user:hover {
    background: rgba(255,255,255,0.4);
}

/* Pop-up code */
.popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255,255,255,0.95);
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    display: none;
    flex-direction: column;
    align-items: center;
}

.popup p {
    font-size: 18px;
    margin-bottom: 10px;
}

.popup button {
    width: 80%;
    margin: 5px 0;
}

</style>
</head>
<body>

<div class="container">
    <h2 style="color:white;">Envoi de fichiers P2P</h2>

    <input type="text" id="username" placeholder="Ton pseudo">
    <button id="registerBtn">Valider</button>

    <input type="text" id="search" placeholder="Nom du destinataire">
    <div class="user-list" id="userList"></div>

    <input type="file" id="fileInput">
    <button id="sendBtn">Envoyer</button>
</div>

<div class="popup" id="popup">
    <p id="popupText"></p>
    <button id="copyCode">Copier</button>
    <button id="closePopup">Fermer</button>
</div>

<script>
const SIGNALING_SERVER = "ws://192.168.1.51:8080"; // ton serveur local
let ws = new WebSocket(SIGNALING_SERVER);

let username = "";
let users = [];
let fileToSend = null;

ws.onopen = () => console.log("Connecté au serveur de signalisation");

ws.onmessage = (message) => {
    let data = JSON.parse(message.data);
    if(data.type === "user-list") {
        users = data.list.filter(u => u !== username);
        updateUserList();
    }
    if(data.type === "code") {
        showPopup(data.code);
    }
};

document.getElementById("registerBtn").onclick = () => {
    username = document.getElementById("username").value.trim();
    if(username) {
        ws.send(JSON.stringify({ type:"register", username }));
        alert("Pseudo enregistré : " + username);
    } else alert("Entre un pseudo !");
};

function updateUserList() {
    const listDiv = document.getElementById("userList");
    listDiv.innerHTML = "";
    users.forEach(u => {
        const div = document.createElement("div");
        div.className = "user";
        div.textContent = u;
        div.onclick = () => document.getElementById("search").value = u;
        listDiv.appendChild(div);
    });
}

document.getElementById("fileInput").onchange = (e) => {
    fileToSend = e.target.files[0];
};

document.getElementById("sendBtn").onclick = () => {
    const dest = document.getElementById("search").value.trim();
    if(dest && fileToSend) {
        const code = Math.random().toString(36).substring(2,8).toUpperCase();
        ws.send(JSON.stringify({ type:"code", to: dest, code }));
        alert("Code envoyé : " + code);
    } else alert("Choisis un destinataire et un fichier !");
};

function showPopup(code) {
    const popup = document.getElementById("popup");
    document.getElementById("popupText").textContent = "Code : " + code;
    popup.style.display = "flex";
    document.getElementById("copyCode").onclick = () => navigator.clipboard.writeText(code);
    document.getElementById("closePopup").onclick = () => popup.style.display = "none";
}
</script>

</body>
</html>
