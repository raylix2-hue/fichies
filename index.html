<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Envoi de fichiers P2P</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(10px);
        margin: 0; padding: 0;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        height: 100vh;
    }
    input, button {
        padding: 10px;
        margin: 5px;
        border-radius: 8px;
        border: 1px solid #ccc;
    }
    .user-list { margin-top: 20px; }
    .user { cursor: pointer; padding: 5px; }
    .popup { position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%);
             background: white; padding: 20px; border-radius: 12px; display: none; box-shadow: 0 0 15px rgba(0,0,0,0.3);}
</style>
</head>
<body>

<h2>Envoi de fichiers P2P</h2>

<input type="text" id="username" placeholder="Ton pseudo">
<button id="registerBtn">Valider</button>

<input type="text" id="search" placeholder="Nom du destinataire">
<div class="user-list" id="userList"></div>

<input type="file" id="fileInput">
<button id="sendBtn">Envoyer</button>

<div class="popup" id="popup">
    <p id="popupText"></p>
    <button id="copyCode">Copier</button>
    <button id="closePopup">Fermer</button>
</div>

<script>
const SIGNALING_SERVER = "ws://192.168.1.51:8080"; // ton IP locale
let ws = new WebSocket(SIGNALING_SERVER);

let username = "";
let users = [];
let fileToSend = null;

ws.onopen = () => console.log("Connecté au serveur de signalisation");

ws.onmessage = (message) => {
    let data = JSON.parse(message.data);
    if(data.type === "user-list") {
        users = data.list;
        updateUserList();
    }
    if(data.type === "code") {
        showPopup(data.code);
    }
};

document.getElementById("registerBtn").onclick = () => {
    username = document.getElementById("username").value.trim();
    if(username) {
        ws.send(JSON.stringify({ type:"register", username }));
        alert("Pseudo enregistré : " + username);
    }
};

function updateUserList() {
    const listDiv = document.getElementById("userList");
    listDiv.innerHTML = "";
    users.forEach(u => {
        if(u !== username) {
            const div = document.createElement("div");
            div.className = "user";
            div.textContent = u;
            div.onclick = () => document.getElementById("search").value = u;
            listDiv.appendChild(div);
        }
    });
}

document.getElementById("fileInput").onchange = (e) => {
    fileToSend = e.target.files[0];
};

document.getElementById("sendBtn").onclick = () => {
    const dest = document.getElementById("search").value.trim();
    if(dest && fileToSend) {
        const code = Math.random().toString(36).substring(2,8).toUpperCase();
        ws.send(JSON.stringify({ type:"code", to: dest, code }));
        alert("Code envoyé : " + code);
    } else alert("Choisis un destinataire et un fichier !");
};

function showPopup(code) {
    const popup = document.getElementById("popup");
    document.getElementById("popupText").textContent = "Code : " + code;
    popup.style.display = "block";
    document.getElementById("copyCode").onclick = () => navigator.clipboard.writeText(code);
    document.getElementById("closePopup").onclick = () => popup.style.display = "none";
}
</script>

</body>
</html>
